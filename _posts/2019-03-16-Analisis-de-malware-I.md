---
layout: post
title:  "Analisis de malware I"
date:   2019-03-23
image:  "malware.jpg"
description: "Analisis de malware desde 0 con ejercicios practicos."
tags:   [Malware, Analisis de malware, Herramientas Utiles, Hacking desde 0]
---

El anÃ¡lisis de malware es el estudio o proceso para determinar la funcionalidad, el origen y el impacto potencial de una muestra determinada de malware, como un virus, un gusano, un troyano, un rootkit o una puerta trasera.  
[Fuente Wikipedia](https://es.wikipedia.org/wiki/An%C3%A1lisis_de_malware)  
En el dia de hoy vamos aprender un poco de como realizar un analisis estatico de malware.  
Para ello utilizare los ejercicios con dificultad principiantes de [MalwareTech](https://www.malwaretech.com/beginner-malware-reversing-challenges).  
	- Strings1
	- Strings2
	- Strings3

### MalwareTech Ejercicio #1 - **Strings1**
Para este ejercicio iniciamos comprobando que tipo de archivo es:  

{% highlight shell %}
file strings1.exe_
--> strings1.exe_: PE32 executable (GUI) Intel 80386, for MS Windows
{% endhighlight %}

Al identificar el tipo de archivo, procedi a ejecutarlo con wine.  

{% highlight shell %}
wine strings1.exe_
{% endhighlight %}

La ejecucion del archivo muestra una ventana emergente con un hash en MD5, el cual probablemente sea el flag encriptado.  

<figure>
  <img src="{{site.baseurl}}/img/MalwExec1.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwExec1.png" title="Ejecucion del archivo con WINE">Iniciando un ejecutable de windows con WINE</a>.
  </figcaption>
</figure>

El paso siguiente es ver las cadenas de caracteres imprimibles del archivo.  

{% highlight shell %}
strings strings1.exe_
{% endhighlight %}

<figure>
  <img src="{{site.baseurl}}/img/MalwStringsFile1.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwStringsFile1.png" title="Uso del comando strings">Analizando cadenas imprimibles del ejecutable</a>.
  </figcaption>
</figure>

Como podemos ver nos imprime muchas flag, decidi pasar todas esas flag a MD5 y compararlas con el hash inicial.  

{% highlight shell %}
for i in $(strings strings1.exe_ | grep 'FLAG'); do echo -n $i | md5sum | cut -d' ' -f1 | grep '4c827c4ca62781d707cd049da13539ee' && echo $i; done
--> FLAG{CAN-I-MAKE-IT-ANYMORE-OBVIOUS}
{% endhighlight %}

### MalwareTech Ejercicio #2 - **Strings2**
Al igual que en el primer ejercicio iniciamos validando el tipo de archivo con el siguiente comando:  

{% highlight shell %}
file strings2.exe_
--> strings2.exe_: PE32 executable (GUI) Intel 80386, for MS Windows
{% endhighlight %}

Al identificar el tipo de archivo, procedi a ejecutarlo con wine.  

{% highlight shell %}
wine strings2.exe_
{% endhighlight %}

La ejecucion del archivo muestra una ventana emergente con un hash en MD5, el cual probablemente sea el flag encriptado.  

<figure>
  <img src="{{site.baseurl}}/img/MalwExec2.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwExec2.png" title="Ejecucion del archivo con WINE">Iniciando un ejecutable de windows con WINE</a>.
  </figcaption>
</figure>

Examinamos las cadenas del ejecutable:  

{% highlight shell %}
strings strings2.exe_
{% endhighlight %}

<figure>
  <img src="{{site.baseurl}}/img/MalwStringsFile2.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwStringsFile2.png" title="Uso del comando strings">Analizando cadenas imprimibles del ejecutable</a>.
  </figcaption>
</figure>

Nuevamente examinamos las cadenas del ejecutable pero esta vez con el parametro "-eS" para que imprima en forma de caracteres de 8 bits.  
Analizamos que hay una linea interesante:  

{% highlight shell %}
strings -eS strings2.exe_
{% endhighlight %}  

<figure>
  <img src="{{site.baseurl}}/img/MalwStrings2File2.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwStrings2File2.png" title="Uso del comando strings con parametros">Examinando las cadenas del ejecutable en 8 bits</a>.
  </figcaption>
</figure>

Procedemos eliminando todas las letras "E", y listo tenemos nuestra flag.  

{% highlight shell %}
echo 'EFELEAEGE{ESETEAECEKE-ESETEREIENEGESE-EAEREEE-EBEEESETE-ESETEREIENEGESE}' | tr -d 'E'
--> FLAG{STACK-STRINGS-AR-BST-STRINGS}
{% endhighlight %}  

### MalwareTech Ejercicio #3 - **Strings3**
Al igual que en el primer ejercicio iniciamos validando el tipo de archivo con el siguiente comando:

{% highlight shell %}
file strings
--> strings3.exe_: PE32 executable (GUI) Intel 80386, for MS Windows
{% endhighlight %}  

Al identificar el tipo de archivo, procedemos a ejecutarlo con wine.

{% highlight shell %}
wine strings3.exe_
{% endhighlight %}  

La ejecucion del archivo muestra una ventana emergente con un hash en MD5, el cual probablemente sea el flag encriptado.

<figure>
  <img src="{{site.baseurl}}/img/MalwExec3.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwExec3.png" title="Ejecucion del archivo con WINE">Iniciando un ejecutable de windows con WINE</a>.
  </figcaption>
</figure>

Examinamos las cadenas del ejecutable:

{% highlight shell %}
strings strings3.exe_
{% endhighlight %}  

<figure>
  <img src="{{site.baseurl}}/img/MalwStringsFile3.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwStringsFile3.png" title="Uso del comando strings">Examinando las cadenas del ejecutable</a>.
  </figcaption>
</figure>

Nuevamente examinamos las cadenas del ejecutable pero esta vez con el parametro "-el" para que imprima en forma de caracteres de 16 bits.

{% highlight shell %}
strings -el strings3.exe_
{% endhighlight %}  

<figure>
  <img src="{{site.baseurl}}/img/MalwStrings3File3.png">
	<figcaption>
    <a href="{{site.baseurl}}/img/MalwStrings3File3" title="Uso del comando strings con parametros">Examinando las cadenas del ejecutable en 16 bits</a>.
  </figcaption>
</figure>

Y finalmente limpiamos los FLAGS y los comparamos con el hash inicial.  

{% highlight shell %}
for i in $(strings -el strings3.exe_ | grep -oP 'FLAG{(.*?)}'); do echo -n $i | md5sum | cut -d' ' -f 1 | grep '1011cafbd736cdf2ae90964613c911fe' && echo $i ; done
--> FLAG{RESOURCES-ARE-POPULAR-FOR-MALWARE}
{% endhighlight %}  
